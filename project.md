## 梳理

大概20个项目左右

管理后台：operation， athena

精选业务后台： aresapi， ares

线上服务：cpsstore，cpssearch，cps_resource cpsuser newcps openapi

搜索服务：essearch cerebro

降级服务：cpsmock

日志监控：filebeat，logstash cpsmonitor

服务治理： opdev websocket iris

测试： testnewcps

机器： 双机房，60台机器，每个机房30个，通过调整权重控制流量，路由规则转发，线上服务40台机器，每个机房20个

qps相关：量最大的接口：ng每天：2亿4千万多量，qps2800，99.9line在20ms左右，透过ng，1亿4千万，qps1600，单台机器在700万，qps90左右，mc缓存命中在93左右

ng5分钟缓存

核心流量：购买支付，阅读
非核心流量：可降级的不影响用户体验

ng负载均衡5种策略： 1 轮询 2 权重 weight 3 ip_hash session存本地问题 4 fair 服务器响应时间分配 5 url hash 缓存有效

流量控制：

1、缓存

2、降级

3、熔断 比如在调用链路中某个资源出现不稳定状态时（例如调用超时或异常比例升高），对这个资源的调用进行限制，让请求快速失败，避免影响到其它的资源而导致级联错误

4、流量权重分配

架构相关：

双活机房，AP双活（根据业务分类，以A为主,B为备 需要切换，只有一个业务在运行），AA双活（真正 的双活，负载均衡，同一个站点可以同时承担起所有对外访问的业务，可以做到真正的业务负载均衡同时故障可无缝切换，提升了数据中心的整体对外服务能力）

AP AA相结合

无状态AA：书城渲染，数据获取

有状态AP：用户中心，数据部门，只在一个机房


权限系统：

五张表： resource 菜单id配置， role 角色id配置， resource， role关联关系配置， userid表， user role关联表

后台通过配置菜单，新页面得到菜单id， 配置角色，对应菜单生成角色，然后角色挂到用户上，达到菜单级别的权限，用户在操作前会进行权限校验，登录后获取该角色的权限获取关联菜单

按钮权限：角色关联菜单时，每个菜单添加管理员，观察员权限，然后操作按钮那块加装饰器，传入允许的权限，当用户操作时就会进入装饰器进行权限校验，获取角色的权限，然后校验，不在的话就拒绝

登录系统：

前端限制特殊header校验， rsa加解密，校验数据库密码对不对，返回sessionid，获取最近登陆日期，如果超过60天自动冻结。将session保存到redis

并将基本信息返回到前端，登录成功，本地存储token，用户信息，前端请求后端检查过期时间

websocket：

1、前端初始化登陆成功，连接websocket， 项目启动初始化连接，连接成功后，本地保存该用户的redis连接

2、异步任务执行完成后，发送信息，请求接口，将信息pub到redis队列，websocket项目监听的redis的队列，得到信息，根据用户属性获取链接，发送

3、心跳 60秒发送一次，保证心跳，最大重试次数5次

private：

jwt token 路由检查， 配合redis检查jwttoken过期问题，校验token对不对，其他设备登录的问题

gin框架的问题

beego框架